<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Spaces | Connected</title>
    <style>
        /* --- THEME SETTINGS --- */
        :root {
            --bg-deep: #020617;     /* Darkest Midnight */
            --bg-panel: #0f172a;    /* Panel Blue */
            --primary: #6366f1;     /* Indigo Star */
            --accent: #14b8a6;      /* Teal Nebula */
            --text-main: #f8fafc;   /* Starlight White */
            --text-dim: #94a3b8;    /* Muted Blue */
            --border: #1e293b;
            --radius: 12px;
        }

        /* --- RESET & BASICS --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main);
            min-height: 100vh;
            /* Starry Background Effect */
            background-image: radial-gradient(white 1px, transparent 1px), radial-gradient(white 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            background-attachment: fixed;
        }

        /* --- UTILITIES --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        
        button { cursor: pointer; border: none; outline: none; transition: 0.2s; }
        
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #4f46e5; }
        .btn-ghost { background: transparent; color: var(--text-dim); }
        .btn-ghost:hover { color: var(--accent); background: rgba(255,255,255,0.05); }

        input, textarea {
            background: #1e293b; border: 1px solid #334155; color: white;
            padding: 12px; border-radius: 8px; width: 100%; display: block; margin-bottom: 10px;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        /* --- LAYOUT --- */
        header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 50; padding: 15px 0;
        }

        .logo { font-size: 1.5rem; font-weight: bold; color: var(--accent); letter-spacing: 1px; }

        .app-grid {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        /* --- SIDEBAR --- */
        .sidebar-card { background: var(--bg-panel); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); }
        .nav-item {
            display: block; padding: 10px; color: var(--text-dim); border-radius: 6px; margin-bottom: 5px; cursor: pointer;
        }
        .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .hashtag { color: var(--accent); cursor: pointer; font-size: 0.9rem; }

        /* --- CARDS & POSTS --- */
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; animation: fadeIn 0.4s ease; }
        
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); object-fit: cover; }
        .post-author { font-weight: bold; color: white; }
        .post-time { font-size: 0.8rem; color: var(--text-dim); }
        .post-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; color: var(--accent); }
        .post-body { line-height: 1.6; color: #cbd5e1; white-space: pre-wrap; }

        /* --- CHAT SYSTEM --- */
        .chat-layout { display: grid; grid-template-columns: 200px 1fr; height: 500px; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: var(--bg-panel); }
        .friend-list { border-right: 1px solid var(--border); overflow-y: auto; background: #0f172a; }
        .friend-item { padding: 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .friend-item:hover { background: #1e293b; }
        .chat-window { display: flex; flex-direction: column; background: #020617; }
        .messages-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 14px; border-radius: 12px; max-width: 70%; font-size: 0.95rem; }
        .msg-me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg-them { align-self: flex-start; background: #334155; color: white; border-bottom-left-radius: 2px; }
        .chat-input { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: var(--bg-panel); }

        /* --- PROFILE --- */
        .profile-hero { text-align: center; padding: 40px 20px; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 20px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            .app-grid { grid-template-columns: 1fr; }
            .sidebar-card { display: none; } /* Mobile simplified */
            .chat-layout { grid-template-columns: 1fr; }
            .friend-list.mobile-hidden { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container flex-between">
            <div class="logo">‚ú® Infinity Spaces</div>
            
            <div id="nav-actions" class="flex hidden">
                <input type="text" id="searchInput" placeholder="Search..." style="margin:0; width:200px;" onkeyup="app.search(this.value)">
                <button class="btn btn-ghost" onclick="app.logout()">Log Out</button>
            </div>
        </div>
    </header>

    <main class="container">
        
        <div id="view-auth" class="card" style="max-width: 400px; margin: 60px auto; text-align: center;">
            <h2 style="margin-bottom: 10px;">Welcome Traveler</h2>
            <p style="color: var(--text-dim); margin-bottom: 20px;">Enter your callsign to begin.</p>
            <input type="text" id="usernameInput" placeholder="Choose a Username">
            <button class="btn btn-primary" style="width: 100%;" onclick="app.login()">Enter The Void</button>
            <br><br>
            <button class="btn btn-ghost" onclick="app.hardReset()" style="font-size: 0.8rem; color: #ef4444;">‚ö† Fix/Reset App Data</button>
        </div>

        <div id="view-app" class="app-grid hidden">
            
            <aside class="sidebar-card">
                <div class="nav-item active" onclick="app.nav('feed')">üè† Global Feed</div>
                <div class="nav-item" onclick="app.nav('messages')">üí¨ Direct Messages</div>
                <div class="nav-item" onclick="app.nav('profile')">üë§ My Profile</div>
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 15px 0;">
                <h4 style="color: var(--accent); margin-bottom: 10px; font-size: 0.9rem;">TOPIC CLUSTERS</h4>
                <div class="nav-item" onclick="app.filter('#Anxiety')">#Anxiety</div>
                <div class="nav-item" onclick="app.filter('#Venting')">#Venting</div>
                <div class="nav-item" onclick="app.filter('#Wins')">#SmallWins</div>
                <div class="nav-item" onclick="app.filter('#Advice')">#Advice</div>
            </aside>

            <section id="content-area">
                
                <div id="tab-feed">
                    <div class="card">
                        <input type="text" id="postTitle" placeholder="Topic Title...">
                        <textarea id="postContent" style="height: 100px;" placeholder="Share your thoughts... (Use #tags to categorize)"></textarea>
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="app.createPost()">Publish Signal</button>
                        </div>
                    </div>
                    <div id="feed-stream">
                        </div>
                </div>

                <div id="tab-messages" class="hidden">
                    <div class="chat-layout">
                        <div class="friend-list" id="chat-friends">
                            </div>
                        <div class="chat-window">
                            <div id="chat-header" style="padding: 15px; border-bottom: 1px solid var(--border); color: var(--accent);">Select a friend</div>
                            <div id="chat-msgs" class="messages-area"></div>
                            <div class="chat-input">
                                <input type="text" id="msgInput" placeholder="Type..." style="margin:0;">
                                <button class="btn btn-primary" onclick="app.sendMsg()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-profile" class="hidden">
                    <div class="card profile-hero">
                        <img id="profile-img" src="" class="profile-avatar">
                        <h2 id="profile-name">User</h2>
                        <p id="profile-bio" style="color: var(--text-dim);">Bio goes here</p>
                        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 20px;">
                            <div class="card" style="padding: 10px 20px;">
                                <h3 id="stat-posts" style="color: var(--primary);">0</h3>
                                <small>Posts</small>
                            </div>
                            <div class="card" style="padding: 10px 20px;">
                                <h3 id="stat-friends" style="color: var(--primary);">0</h3>
                                <small>Friends</small>
                            </div>
                        </div>
                        <hr style="border:0; border-top:1px solid var(--border); margin: 20px 0;">
                        <h4 style="margin-bottom: 10px;">Edit Profile</h4>
                        <input type="text" id="edit-bio" placeholder="Update Bio">
                        <input type="text" id="edit-img" placeholder="Update Image URL">
                        <button class="btn btn-primary" onclick="app.saveProfile()">Save Changes</button>
                    </div>
                </div>

                <div id="tab-viewuser" class="hidden">
                    <div class="card profile-hero">
                        <button class="btn btn-ghost" style="float: left;" onclick="app.nav('feed')">‚Üê Back</button>
                        <br clear="all">
                        <img id="view-img" src="" class="profile-avatar">
                        <h2 id="view-name">User</h2>
                        <p id="view-bio">...</p>
                        <br>
                        <button id="btn-addfriend" class="btn btn-primary" onclick="">Add Friend</button>
                    </div>
                </div>

            </section>
        </div>
    </main>

    <script>
        const app = {
            data: { users: [], posts: [], messages: [] },
            user: null,
            activeChat: null,
            VERSION: '2.0', // Used to force data reset if structure changes

            init: function() {
                // 1. Check for corrupted or old data
                const storedVer = localStorage.getItem('infinity_version');
                if (storedVer !== this.VERSION) {
                    // Wipe old data to prevent "nothing working" errors
                    localStorage.removeItem('infinity_data');
                    localStorage.setItem('infinity_version', this.VERSION);
                    this.seedData();
                } else {
                    const storedData = localStorage.getItem('infinity_data');
                    if (storedData) this.data = JSON.parse(storedData);
                    else this.seedData();
                }

                // 2. Check Session
                const sessionUser = sessionStorage.getItem('infinity_session');
                if (sessionUser) {
                    this.login(sessionUser);
                }
            },

            seedData: function() {
                // Default data for new users
                this.data.users = [
                    { username: 'Admin', bio: 'Creator of the void.', avatar: 'https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff', friends: [] },
                    { username: 'Hope_Bot', bio: 'I am here to help.', avatar: 'https://ui-avatars.com/api/?name=Hope+Bot&background=14b8a6&color=fff', friends: [] }
                ];
                this.data.posts = [
                    { id: 1, author: 'Admin', title: 'Welcome Home', content: 'This is a safe space. Use #tags to find your community.', time: new Date().toLocaleString() }
                ];
                this.save();
            },

            save: function() {
                localStorage.setItem('infinity_data', JSON.stringify(this.data));
            },

            /* --- AUTHENTICATION --- */
            login: function(savedName = null) {
                const input = document.getElementById('usernameInput');
                const name = savedName || input.value.trim();
                
                if (!name) return alert("Please enter a username!");

                // Find or create user
                let existing = this.data.users.find(u => u.username.toLowerCase() === name.toLowerCase());
                if (!existing) {
                    existing = { 
                        username: name, 
                        bio: 'New traveler.', 
                        avatar: `https://ui-avatars.com/api/?name=${name}&background=random`, 
                        friends: [] 
                    };
                    this.data.users.push(existing);
                    this.save();
                }

                this.user = existing;
                sessionStorage.setItem('infinity_session', existing.username);

                // Switch UI
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('nav-actions').classList.remove('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                
                this.nav('feed');
            },

            logout: function() {
                sessionStorage.removeItem('infinity_session');
                location.reload();
            },

            hardReset: function() {
                if(confirm("This will delete all data and fix any errors. Continue?")) {
                    localStorage.clear();
                    location.reload();
                }
            },

            /* --- NAVIGATION --- */
            nav: function(tab) {
                // Hide all tabs
                ['feed', 'messages', 'profile', 'viewuser'].forEach(t => {
                    document.getElementById('tab-' + t).classList.add('hidden');
                });
                // Remove active class from sidebar
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));

                // Show selected
                document.getElementById('tab-' + tab).classList.remove('hidden');

                if (tab === 'feed') this.renderFeed();
                if (tab === 'profile') this.renderProfile();
                if (tab === 'messages') this.renderFriends();
            },

            /* --- FEED SYSTEM --- */
            createPost: function() {
                const title = document.getElementById('postTitle').value;
                const content = document.getElementById('postContent').value;
                if(!title || !content) return alert("Please fill in both fields.");

                this.data.posts.unshift({
                    id: Date.now(),
                    author: this.user.username,
                    title: title,
                    content: content,
                    time: new Date().toLocaleString()
                });
                
                this.save();
                this.renderFeed();
                // Clear inputs
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
            },

            renderFeed: function(filter = null) {
                const container = document.getElementById('feed-stream');
                container.innerHTML = '';

                let posts = this.data.posts;
                if (filter) {
                    posts = posts.filter(p => p.content.includes(filter) || p.title.includes(filter));
                }

                posts.forEach(p => {
                    const authorObj = this.data.users.find(u => u.username === p.author) || { avatar: '' };
                    
                    // Highlight tags
                    const safeContent = p.content.replace(/#(\w+)/g, '<span class="hashtag" onclick="app.filter(\'#$1\')">#$1</span>');

                    const html = `
                        <div class="card">
                            <div class="post-header">
                                <img src="${authorObj.avatar}" class="avatar" onclick="app.viewUser('${p.author}')" style="cursor:pointer">
                                <div>
                                    <div class="post-author" onclick="app.viewUser('${p.author}')" style="cursor:pointer">@${p.author}</div>
                                    <div class="post-time">${p.time}</div>
                                </div>
                            </div>
                            <div class="post-title">${p.title}</div>
                            <div class="post-body">${safeContent}</div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            },

            search: function(query) {
                this.nav('feed'); // force switch to feed
                this.renderFeed(query);
            },

            filter: function(tag) {
                this.nav('feed');
                this.renderFeed(tag);
            },

            /* --- USER & FRIENDS --- */
            viewUser: function(name) {
                if (name === this.user.username) return this.nav('profile');

                const target = this.data.users.find(u => u.username === name);
                if (!target) return;

                this.nav('viewuser');
                document.getElementById('view-name').innerText = target.username;
                document.getElementById('view-bio').innerText = target.bio;
                document.getElementById('view-img').src = target.avatar;

                const btn = document.getElementById('btn-addfriend');
                const isFriend = this.user.friends.includes(name);

                if (isFriend) {
                    btn.innerText = "Message User";
                    btn.onclick = () => { app.nav('messages'); app.loadChat(name); };
                } else {
                    btn.innerText = "Add Friend";
                    btn.onclick = () => app.addFriend(name);
                }
            },

            addFriend: function(name) {
                // Add mutual friendship
                const me = this.data.users.find(u => u.username === this.user.username);
                const them = this.data.users.find(u => u.username === name);

                if (!me.friends.includes(name)) me.friends.push(name);
                if (!them.friends.includes(me.username)) them.friends.push(me.username);

                this.save();
                this.user = me; // update session
                alert(`You are now connected with ${name}`);
                this.viewUser(name); // refresh view
            },

            /* --- MESSAGING --- */
            renderFriends: function() {
                const list = document.getElementById('chat-friends');
                list.innerHTML = '';
                
                if (this.user.friends.length === 0) {
                    list.innerHTML = '<div style="padding:15px; color:#aaa; font-size:0.9rem;">Add friends from the Feed to chat!</div>';
                    return;
                }

                this.user.friends.forEach(fName => {
                    const fObj = this.data.users.find(u => u.username === fName);
                    list.innerHTML += `
                        <div class="friend-item" onclick="app.loadChat('${fName}')">
                            <img src="${fObj.avatar}" style="width:20px; height:20px; border-radius:50%; vertical-align:middle; margin-right:5px;">
                            <b>${fName}</b>
                        </div>
                    `;
                });
            },

            loadChat: function(friendName) {
                this.activeChat = friendName;
                document.getElementById('chat-header').innerText = `Talking to ${friendName}`;
                this.renderMessages();
            },

            sendMsg: function() {
                if (!this.activeChat) return alert("Select a friend first");
                const input = document.getElementById('msgInput');
                const txt = input.value.trim();
                if (!txt) return;

                this.data.messages.push({
                    from: this.user.username,
                    to: this.activeChat,
                    text: txt,
                    ts: Date.now()
                });
                this.save();
                this.renderMessages();
                input.value = '';
            },

            renderMessages: function() {
                if (!this.activeChat) return;
                const area = document.getElementById('chat-msgs');
                area.innerHTML = '';

                const relevant = this.data.messages.filter(m => 
                    (m.from === this.user.username && m.to === this.activeChat) ||
                    (m.from === this.activeChat && m.to === this.user.username)
                );

                relevant.forEach(m => {
                    const isMe = m.from === this.user.username;
                    area.innerHTML += `<div class="msg ${isMe ? 'msg-me' : 'msg-them'}">${m.text}</div>`;
                });
                
                area.scrollTop = area.scrollHeight;
            },

            /* --- PROFILE SELF --- */
            renderProfile: function() {
                document.getElementById('profile-name').innerText = this.user.username;
                document.getElementById('profile-bio').innerText = this.user.bio;
                document.getElementById('profile-img').src = this.user.avatar;
                document.getElementById('stat-friends').innerText = this.user.friends.length;
                
                const postCount = this.data.posts.filter(p => p.author === this.user.username).length;
                document.getElementById('stat-posts').innerText = postCount;

                document.getElementById('edit-bio').value = this.user.bio;
                document.getElementById('edit-img').value = this.user.avatar;
            },

            saveProfile: function() {
                const me = this.data.users.find(u => u.username === this.user.username);
                me.bio = document.getElementById('edit-bio').value;
                me.avatar = document.getElementById('edit-img').value;
                
                this.user = me;
                this.save();
                this.renderProfile();
                alert("Profile Updated");
            }
        };

        // Start App
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>